<!DOCTYPE html>
<html>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3mobile.css">

    <style>
        .blink_me {
            animation: blinker 0.545s linear infinite; /*frequency 120 per min (CPR: 100-120 per min)*/
            opacity: 1;
        }
        @keyframes blinker {
            50% { opacity: 0; }
        }
        .custom_title{
            background-color: #ecf35b;
        }
        button {
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            /*margin: 4px 2px;*/
            cursor: pointer;
        }
        #buttons button {
            background-color: #f44336;
        }
    </style>

    <body>

        <!-- Webpage starts here  -->
        <center>
        <div class="w3-container w3-card custom_title">
            <h1>Resuscitation Drone</h1>
            <!-- <p><i>Autonomous AED Delivery</i></p> -->
        </div>

        <div id="buttons">
            <br />
          <!-- <button onclick="getLocation()">Request AED - Static</button>
          <br> -->
          <!-- <button onclick="getLocationDynamic()">Request AED</button> -->
          <button onclick="getLocationStart()">REQUEST AED</button>
        </div>
        </center>

        <center>
            <p id="Info"></p>

            <p id="ExtraInfo"></p>
            <p id="Error"></p>
            <p id="Statusp"></p>
            <p id="ETAp"></p>
        </center>

        <div id="googleMap" style="width:100%;height:400px;"></div>
        <!-- Webpage ends here  -->

        <!-- From here it is purely JavaScript  -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
        <script>
        options = {
            enableHighAccuracy: true
        };
        var InfoHolder = document.getElementById("Info");
        var ExtraInfoHolder = document.getElementById("ExtraInfo");
        var ErrorHolder = document.getElementById("Error");

        var ETAHolder = document.getElementById("ETAp");
        var StatusHolder = document.getElementById("Statusp");

        var buttonsDiv = document.getElementById("buttons");

        var firstRun = 1;
        var firstGPStimestamp;
        var lastGPStimestamp;
        var LatLng;
        var measurements = 0;
        var LocTimer;

        var firstRunMap = 1;
        var map;
        var marker_human;
        var marker_human_help_icon = 'https://www.techgen.dk/AED/marker_human_help.png';
        var marker_aed;
        var marker_aed_icon = 'https://www.techgen.dk/AED/marker_aed.png';

        var marker_human_help_icon_google;
        var marker_aed_icon_google;

        var aed_status_timer;
        var aedLatLng;

        function getLocationStart() {
        //    LocTimer = setInterval(getLocation, 1000);
            aed_status_timer = setInterval(get_aed_info, 500);
            getLocation();
        }

        function getLocation() {
            if (firstRun) {
            	buttonsDiv.style.display = 'none';
                InfoHolder.innerHTML = '<span style="color:red;">PLEASE STAY ON THE CURRENT WEBPAGE!</span><br /><h3 class="blink_me" style="color:green; margin-bottom:0px;"><b>PERFORM CPR UNTIL THE AED ARRIVES</b></h3><p style="-webkit-margin-before: 0px;"><i>CPR Instruction: Push straight down on (compress) the chest each time the text blinks and perfom 2 rescue breaths every 30 compression</i></p>';
            }
            if (navigator.geolocation) {
                //clearInterval(LocTimer);
                navigator.geolocation.getCurrentPosition(showPosition, showError, options);
                //LocTimer = setInterval(getLocation, 1000);
            } else {
                InfoHolder.innerHTML = "Geolocation is not supported by this browser.";
            }
        }


        function getLocationDynamic() {
            if (firstRun) {
            	buttonsDiv.style.display = 'none';
                InfoHolder.innerHTML = '<span style="color:red;">PLEASE STAY ON THE CURRENT WEBPAGE!</span><br /><h3 class="blink_me" style="color:green; margin-bottom:0px;"><b>PERFORM CPR UNTIL THE AED ARRIVES</b></h3><p style="-webkit-margin-before: 0px;"><i>CPR Instruction: Push straight down on (compress) the chest each time the text blinks</i></p>';
            }
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(showPosition, showError, options);
            } else {
                InfoHolder.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function showPosition(position) {
            if (measurements < 19 ) {
                measurements = measurements + 1;
                setTimeout(function(){ getLocation(); }, 1000);
            }
            //ErrorHolder.innerHTML = "Measurement " + measurements;
            //InfoHolder.innerHTML = '<strong>An AED equipped drone is being sent to your location</strong><br /><i>(lat: '+position.coords.latitude+', lng: '+position.coords.longitude+')</i><br /><span style="color:red;">PLEASE STAY ON THE CURRENT WEBPAGE!</span><br /><h3 class="blink_me" style="color:green;"><b>PERFORM CPR UNTIL THE AED ARRIVES</b></h3><p><i>Push straight down on (compress) the chest each time the text blinks</i></p>';

            // ExtraInfo.innerHTML = "Accuracy: " + position.coords.accuracy + "<br>"
            // + "Timestamp: " + position.timestamp + "<br>"
            // + "Altitude: " + position.coords.altitude + "<br>"
            // + "Altitude accuracy: " + position.coords.altitudeAccuracy + "<br>"
            // + "Heading: " + position.coords.heading + "<br>"
            // + "Speed: " + position.coords.speed;
            // Note that the more which is being returned the slower it becomes.

            if (lastGPStimestamp != position.timestamp) {
                if (firstRun) {
                    firstGPStimestamp = position.timestamp;
                    firstRun=0;
                }

                // Static map without marker
                // var latlon = position.coords.latitude + "," + position.coords.longitude;
                // var img_url = "https://maps.googleapis.com/maps/api/staticmap?center="
                // +latlon+"&zoom=14&size=400x300&key=AIzaSyDTHa8VL03UUNRQdlxNm99TaUzTsK2v6Ls";
                // document.getElementById("mapholder").innerHTML = "<img src='"+img_url+"'>";

                LatLng = {lat: position.coords.latitude, lng: position.coords.longitude};
                myMap(LatLng, aedLatLng);

                $.ajax({
                    url: "add_smartphone_request.php",
                    type: "POST",
                    dataType: 'json', // or 'text'
                    //contentType: 'application/x-www-form-urlencoded',
                    data: { lat: position.coords.latitude,  lng: position.coords.longitude, GPS_timestamp: position.timestamp, loc_accuracy: position.coords.accuracy, altitude: position.coords.altitude, altitude_accuracy: position.coords.altitudeAccuracy, first_GPS_timestamp: firstGPStimestamp},
                    success: function(msg) {
                        //alert(msg);
                        //var id = msg[0];
                        console.log("Response received!");
                        //ETAHolder.innerHTML = "ETA: " + JSON.stringify(msg).ETA;
                        var rxArray = JSON.parse(JSON.stringify(msg));
                        //console.log("Messsage: "+msg);
                        //console.log("ID: "+id);
                        //StatusHolder.innerHTML = "Status: " + rxArray.AED_status;
                        //ETAHolder.innerHTML = "ETA: " + rxArray.ETA;
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                       console.log(textStatus, errorThrown);
                    }
                });
                lastGPStimestamp = position.timestamp;
            }
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    ErrorHolder.innerHTML = "User denied the request for Geolocation."
                    break;
                case error.POSITION_UNAVAILABLE:
                    ErrorHolder.innerHTML = "Location information is unavailable."
                    break;
                case error.TIMEOUT:
                    ErrorHolder.innerHTML = "The request to get user location timed out."
                    break;
                case error.UNKNOWN_ERROR:
                    ErrorHolder.innerHTML = "An unknown error occurred."
                    break;
            }
        }

        function myMap(myLatLng, in_aedLatLng) {
            if (firstRunMap && myLatLng != null) {
                firstRunMap = 0;
                // Create a map object and specify the DOM element for display.
                // Similar way to exclude additional show: var map = new google.maps.Map(document.getElementById('map'), {
                var mapProp= {
                    //center:new google.maps.LatLng(51.508742,-0.120850),
                    center: myLatLng,
                    mapTypeId: 'hybrid',
                    zoom:16,
                    scaleControl: false,
                    streetViewControl: false,
                    mapTypeControl: false,
                };
                map=new google.maps.Map(document.getElementById("googleMap"),mapProp);

                marker_human_help_icon_google = {
                  url: marker_human_help_icon,
                  // This marker is 30 pixels wide by 36 pixels high.
                  size: new google.maps.Size(30, 36),
                  // The origin for this image is (0, 0).
                  origin: new google.maps.Point(0, 0),
                  // The anchor for this image is the center which is at (15, 17).
                  anchor: new google.maps.Point(15, 17)
                };
                marker_human = new google.maps.Marker({
                  map: map,
                  title: 'Your Position',
                  icon: marker_human_help_icon_google
                });

                marker_aed_icon_google = {
                  url: marker_aed_icon,
                  size: new google.maps.Size(30, 36),
                  origin: new google.maps.Point(0, 0),
                  anchor: new google.maps.Point(15, 17)
                };
                marker_aed = new google.maps.Marker({
                  map: map,
                  title: 'AED Position',
                  icon: marker_aed_icon_google
                });
            } else {
                if (in_aedLatLng != null && in_aedLatLng.lat != 0 && in_aedLatLng.lng != 0) {
                    var avgLatLng = {lat: (myLatLng.lat+in_aedLatLng.lat)/2,lng: (myLatLng.lng+in_aedLatLng.lng)/2};
                    map.panTo(avgLatLng); // Set map new center by panning to it

                } else {
                    map.panTo(myLatLng); // Set map new center by panning to it
                }
                marker_human.setPosition(myLatLng); // Set marker new location
                var tmpvar = myLatLng.lat;
                //var aedlatlng = {lat: myLatLng.lat+0.001-(measurements/20000), lng: myLatLng.lng+0.001-(measurements/20000)};
                if (in_aedLatLng != null && in_aedLatLng.lat != 0 && in_aedLatLng.lng != 0) {
                    marker_aed.setPosition(in_aedLatLng); // Set marker new location
                }
            }
        }
        function get_aed_info() {
            if (firstGPStimestamp != null) {
                $.ajax({
                    url: "get_aed_info.php",
                    type: "POST",
                    dataType: 'json', // or 'text'
                    //contentType: 'application/x-www-form-urlencoded',
                    data: {first_GPS_timestamp: firstGPStimestamp},
                    success: function(msg) {
                        //alert(msg);
                        //var id = msg[0];
                        console.log("Response received!");
                        //ETAHolder.innerHTML = "ETA: " + JSON.stringify(msg).ETA;
                        var rxArray2 = JSON.parse(JSON.stringify(msg));
                        //console.log("Messsage: "+msg);
                        //console.log("ID: "+id);
                        StatusHolder.innerHTML = "Status: <b>" + rxArray2.AED_status + "</b>";
                        ETAHolder.innerHTML = "ETA: <b>" + rxArray2.ETA + "</b>";
                        aedLatLng = {lat: parseFloat(rxArray2.lat),lng: parseFloat(rxArray2.lng)}
                        myMap(LatLng, aedLatLng);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                       console.log(textStatus, errorThrown);
                    }
                });
            }
        }
        </script>

        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTHa8VL03UUNRQdlxNm99TaUzTsK2v6Ls&callback=myMap"
                async defer></script>
    </body>
</html>
